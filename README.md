# SLIMER

This readme covers how to run the GEANT4 simulation for SLIMER, as well as the current procedures for processing experimental data using ImageJ, and comparing experimental and simulation data using ROOT.


**REQUIREMENTS**
- [CMake](https://cmake.org/)
- [GEANT4](http://geant4.web.cern.ch/geant4/)
- [ROOT](https://root.cern.ch/)
- [ImageJ](https://imagej.nih.gov/ij/)

Note that each item listed here has requirements of its own.


**CURRENT BUGS**
- None

**GENERAL NOTES**
- All filepaths in the code are set for my personal computer, and will need to be changed before the macros can be run.
- all_runs.pdf is the run log for all data.
- Some runs end at a number that is not round because occasionally MicroManager would freeze right at the end of a run, especially on the longer ones.


**CONTENTS**

*code*
- CMakeLists and exec.mac should be left alone.
- Run.mac should be modified depending on the desired simulation.

*code_build*
- Everything in this folder should be generated automatically. 
- Temporary changes can be made here, but will be overwritten next time the code is compiled.

*other_code*
- This folder contains all the root scripts used to view and compare data. See "ROOT/SCRIPTS" for more information.

*ImageJ macros*
- See the section for ImageJ.

*root_files*
- This folder is a library of root files generated by the simulation. This limits the necessity of constantly running the simulation repeatedly. All the files should be readily available.

**RUNNING A SIMULATION**

1. If the folder code_build does not already exist in parallel with code, create it. 

2. From code_build, run `sudo cmake -DGeant4_DIR=/path/to/geant4.9.6.p04/lib[64]/Geant4-9.6.0/`

3. From code_build, and as superuser, run `make && make install`. Note: running `sudo make && make install` will not necessarily work.

4. To run the macros, first run `./exec exec.mac` and then `./exec run.mac`.

5. To store the output from run.mac in a text file, use `./exec run.mac >> output.txt`.


-- NOTE: CsI thickness for the simulation can be easily changed by the following process before compiling the simulation:

1. Change into the folder /FILEPATH/SLIMER-master/code/src
2. Use a file editor to modify DetectorConstruction.cc
	- In lines 162-167, uncomment the line that has an hz value of half of the CsI thickness desired
		- Comment out all other lines
3. Change into folder /FILEPATH/SLIMER-master/code
4. Use file editor to modify run.mac
	- In lines 94-99, uncomment the line that includes the CsI thickness desired in its description
		- Comment out all other lines
5. Compile simulation



**IMAGEJ**

Images are analyzed through ImageJ with several macros, run in the following order: 

1. The getAverage macro takes the average of all the images in the set. This is to establish a baseline that can then be subtracted from every image in order to eliminate some background noise.

2. The subtractAverage macro subtracts the generated average from every image.

3. The gaussianBlur macro applies a gaussian blur to every image. This makes events more easily visible.

4. The getResults macro looks for peaks in each image, and records information about all of them that it finds.

5. The eventFinder macro tests every image to see if it contains an event, and copies each image into either an "events" folder or a "noevents" folder.

6. MacroForSmoothed is separate from the first five macros, which are designed to be run together. It produces a data file used by the attempt.cc root macro.

Notes: 
- The macros need to be edited for the filepaths on your computer.
- ImageJ requires Java 8, and at least 4 gb of allocated ram.
- Running more than about 2000 images at once will cause ImageJ to slow down unusably. To process runs that are longer than 2000 images, edit the variables *m* and *n* within the macros to the starting and ending image number, respectively.
- eventFinder sorts the images after the gaussian blur has been applied to them. All the other macros use every image, unsorted. The number of events per run is used in other data, but it's not important for the macros. 
- What we've found so far indicates that eventFinder is fairly accurate, although it picks up about 250 images per 10000 as having events that do not have events. It has no way to count multiple events per image. It works by looking first for pixels that are above a certain grayscale brightness, and then searching for a certain number of pixels in a small square around the bright pixel that are above a different, slightly lower brightness.


**ROOT/SCRIPTS**

Note: All ROOT macros are run in the terminal with `root -l macroname.C` (or macroname.cc) unless otherwise stated.
- addTwoHists.C: The input of this macro can be changed, but its purpose is to add Sr and Y runs together to get a more accurate representation of the decay.
- min_activity.C: Right now, this only plots specific numbers, which are found in a way I do not recall. It determines the minimum activity we should be able to detect in a 10000-image run.
- calgraph.C: This root macro takes the simulation histograms, and manipulates it to try to fit it as closely as possible to the empirical data (of peak height). This is done by first imposing an energy threshold, then by adding a linear shift and a linear expansion along the x-axis to try to match the shape of the data. All variables (Threshold, shift, and expansion) are manipulated in he macro.
- ij2root.C: This root macro takes an input after being run, and turns the .txt files generated by imageJ into a .root file that can be used by all other root macros.
- sim-compare-peak.C: This root macro plots simulation and empirical data for peak height and plots them on the same canvas. Inputs can be changed in the macro itself.
- sim-compare-area.C: This root macro plots simulation and empirical data for peak base area and plots them on the same canvas. Inputs can be changed in the macro itself.
- sim-compare-volume.C: This root macro plots simulationa and empirical data for peak volume and plots them on the same canvas. Inputs can be changed in the macro itself.
- attempt.cc and attempt.hh: This root macro takes as input a text file produced by ImageJ. It plots the mean of each image in the run on the y axis, and the image number on the x axis. I don't remember why we wanted this.
- plotResultsAgain.C and plotResultsAgain.h: This root macro compares multiple different runs. The most common use is to compare two runs where one needs to be subtracted from the other (i.e., a data collection run and a background run). The code is set up so that other histograms can be commented in or out as needed. Histogram 2 is always Histogram 1 minus Histogram 0.
- spacial-Resolution.C: This root macro takes empirical data and plots the x and y positions on a 2-d histogram in order to try to determine where most events occured. This is used when a collumator is used, so we can try to determine where exactly the events occured above the CsI.
